<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1">
  <title>My Profile | Kind-Kart</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <style>
    .profile-photo-container {
      position: relative;
      display: inline-block;
      margin-bottom: 1rem;
    }
    
    .profile-photo-overlay {
      position: absolute;
      bottom: 0;
      right: 0;
      background: rgba(0,0,0,0.7);
      color: white;
      border-radius: 50%;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .profile-photo-overlay:hover {
      background: rgba(0,0,0,0.9);
      transform: scale(1.1);
    }
    
    .file-input-hidden {
      display: none;
    }
    
    .upload-preview {
      max-width: 100%;
      max-height: 200px;
      border-radius: 8px;
      margin-top: 1rem;
    }
  </style>
</head>
<body class="bg-light">
<!-- Navbar -->
<nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm py-3">
  <div class="container">
    <a class="navbar-brand fw-bold d-flex align-items-center" href="main.html">
      <img src="images/logo.png" alt="Kind-Kart Logo" height="40" class="me-2">
      Kind-Kart
    </a>
  </div>
</nav>

<div class="container py-5">
  <div class="row justify-content-center">
    <div class="col-lg-6">
      <div class="card shadow-sm">
        <div class="card-body">
          <h4 class="mb-4">My Profile</h4>
          <div id="msg"></div>
          <form id="profileForm" class="row g-3">
            <div class="col-12 text-center">
              <div class="profile-photo-container">
                <img id="profilePhoto" src="" class="rounded-circle mb-3" style="width:96px;height:96px;object-fit:cover;">
                <div class="profile-photo-overlay" onclick="document.getElementById('photoFile').click()" title="Change Photo">
                  <i class="bi bi-camera"></i>
                </div>
              </div>
              <input type="file" id="photoFile" class="file-input-hidden" accept="image/*">
              <div class="small text-muted mb-3">Click the camera icon to change your profile picture</div>
              <div id="imagePreview" style="display: none;">
                <img id="previewImg" class="upload-preview">
                <div class="mt-2">
                  <button type="button" class="btn btn-sm btn-outline-primary" onclick="useSelectedImage()">Use This Image</button>
                  <button type="button" class="btn btn-sm btn-outline-secondary" onclick="cancelImageSelection()">Cancel</button>
                </div>
              </div>
            </div>
            <div class="col-md-6">
              <label class="form-label">Name</label>
              <input type="text" class="form-control" id="name" required>
            </div>
            <div class="col-md-6">
              <label class="form-label">Phone</label>
              <input type="tel" class="form-control" id="phone" placeholder="+91 ...">
            </div>
            <div class="col-12">
              <label class="form-label">Email</label>
              <input type="email" class="form-control" id="email" disabled>
            </div>
            <div class="col-12 d-grid">
              <button type="submit" class="btn btn-primary">Save Changes</button>
            </div>
          </form>
        </div>
      </div>
      <div class="text-center mt-3">
        <a href="main.html" class="text-decoration-none">&larr; Back to Home</a>
      </div>
    </div>
  </div>
</div>

<script>
const API = 'http://localhost:3000';
let selectedImageFile = null;

function alertBox(el, msg, type='success') {
  el.innerHTML = '<div class="alert alert-'+type+' alert-dismissible fade show" role="alert">'+
                 msg+'<button type="button" class="btn-close" data-bs-dismiss="alert"></button></div>';
}

// Handle file selection
document.getElementById('photoFile').addEventListener('change', function(e) {
  const file = e.target.files[0];
  if (!file) return;
  
  // Validate file type
  if (!file.type.startsWith('image/')) {
    alert('Please select an image file');
    return;
  }
  
  // Validate file size (max 5MB)
  if (file.size > 5 * 1024 * 1024) {
    alert('Image size should be less than 5MB');
    return;
  }
  
  selectedImageFile = file;
  
  // Show preview
  const reader = new FileReader();
  reader.onload = function(e) {
    document.getElementById('previewImg').src = e.target.result;
    document.getElementById('imagePreview').style.display = 'block';
  };
  reader.readAsDataURL(file);
});

function useSelectedImage() {
  if (!selectedImageFile) return;
  
  // Convert image to base64 for storage
  const reader = new FileReader();
  reader.onload = function(e) {
    const base64Image = e.target.result;
    
    // Update profile photo display
    document.getElementById('profilePhoto').src = base64Image;
    
    // Store base64 data for form submission
    document.getElementById('profilePhoto').dataset.base64 = base64Image;
    
    // Hide preview
    document.getElementById('imagePreview').style.display = 'none';
    
    // Clear file input
    document.getElementById('photoFile').value = '';
    selectedImageFile = null;
  };
  reader.readAsDataURL(selectedImageFile);
}

function cancelImageSelection() {
  document.getElementById('imagePreview').style.display = 'none';
  document.getElementById('photoFile').value = '';
  selectedImageFile = null;
}

document.addEventListener('DOMContentLoaded', async () => {
  const msg = document.getElementById('msg');
  const user = JSON.parse(localStorage.getItem('kk_user') || 'null');
  if (!user) {
    alert('Please login first'); window.location.href = 'login.html'; return;
  }

  // Prefill
  document.getElementById('name').value = user.name || '';
  document.getElementById('email').value = user.email || '';
  document.getElementById('phone').value = user.phone || '';
  document.getElementById('profilePhoto').src = user.photo_url || ('https://ui-avatars.com/api/?name=' + encodeURIComponent(user.name || user.email));

  // Fetch fresh from server (in case changed elsewhere)
  try {
    const r = await fetch(API + '/api/users/' + user.id);
    if (r.ok) {
      const data = await r.json();
      const u = data.user;
      document.getElementById('name').value = u.name || '';
      document.getElementById('phone').value = u.phone || '';
      document.getElementById('profilePhoto').src = u.photo_url || ('https://ui-avatars.com/api/?name=' + encodeURIComponent(u.name || u.email));
      localStorage.setItem('kk_user', JSON.stringify(u));
    }
  } catch (e) {}

  // Save
  document.getElementById('profileForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    let photoUrl = user.photo_url || '';
    
    // If user selected a new image, use the base64 data
    if (document.getElementById('profilePhoto').dataset.base64) {
      photoUrl = document.getElementById('profilePhoto').dataset.base64;
    }
    
    const payload = {
      name: document.getElementById('name').value.trim(),
      phone: document.getElementById('phone').value.trim(),
      photo_url: photoUrl
    };
    
    const btn = e.target.querySelector('button[type="submit"]');
    const prev = btn.innerHTML; btn.disabled = true; btn.innerHTML = 'Saving...';
    
    try {
      const res = await fetch(API + '/api/users/' + user.id, {
        method: 'PUT', 
        headers: {'Content-Type':'application/json'}, 
        body: JSON.stringify(payload)
      });
      const data = await res.json();
      if (!res.ok) throw new Error(data.error || 'Failed to update');
      
      // Update localStorage with new user data
      const updatedUser = { ...user, ...data.user };
      localStorage.setItem('kk_user', JSON.stringify(updatedUser));
      
      // Clear the base64 data
      delete document.getElementById('profilePhoto').dataset.base64;
      
      alertBox(msg, 'Profile updated successfully!', 'success');
    } catch (err) {
      alertBox(msg, err.message || 'Update failed', 'danger');
    } finally {
      btn.disabled = false; btn.innerHTML = prev;
    }
  });
});
</script>
</body>
</html>